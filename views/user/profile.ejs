<%- include('../partials/head', { title: 'My Profile' }) %>
<%- include('../partials/header') %>

<main class="container-fluid py-5">
  <div class="row g-4">
    <div class="col-12 col-md-3 col-lg-3">
      <div class="position-sticky" style="top: 5rem;">
        <%- include('../partials/profile-sidebar', { page: 'profile' }) %>
      </div>
    </div>
    <div class="col-12 col-md-9 col-lg-9">
      <div class="ps-md-3 mt-4">
        <h1 class="mb-3">My Profile</h1>
        <hr class="mb-4">

        <% if (locals.user) { %>
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div class="d-flex align-items-center justify-content-center border rounded" style="width: 96px; height: 96px; background: #f8f9fa; overflow: hidden;">
                    <% if (user && user.profileImage) { %>
                      <img id="profileImg" src="<%= user.profileImage %>" alt="Profile photo" class="img-fluid rounded" style="max-width: 100%; max-height: 100%; object-fit: cover;" onerror="this.style.display='none'; document.getElementById('profilePlaceholder').style.display='block';">
                      <i id="profilePlaceholder" class="fas fa-user text-muted" style="font-size: 42px; display: none;"></i>
                    <% } else { %>
                      <i class="fas fa-user text-muted" style="font-size: 42px;"></i>
                    <% } %>
                  </div>
                </div>
                <div>
                  <h5 class="mb-1"><%= user.fullname || user.email %></h5>
                  <div class="text-muted small"><%= user.email %></div>
                  <% if (user.mobile) { %>
                    <div class="text-muted small"><%= user.mobile %></div>
                  <% } %>
                </div>
              </div>

              <hr>
              <div>
                <div class="mb-1"><span class="text-muted">Full Name:</span> <%= user.fullname %></div>
                <div class="mb-1"><span class="text-muted">Email:</span> <%= user.email %></div>
                <% if (user.mobile) { %>
                  <div class="mb-1"><span class="text-muted">Mobile:</span> <%= user.mobile %></div>
                <% } %>
              </div>

              <hr>
              <div class="mt-3">
                <a href="/user/profile/edit" class="btn btn-primary btn-sm me-2">Edit Profile</a>
                <a href="/user/change-password" class="btn btn-secondary btn-sm">Change Password</a>
              </div>
            </div>
          </div>

          <!-- Referral Code Box -->
          <div class="card mt-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">Your Referral Code</h5>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-3">Share your referral code with friends. When they use it, both of you will earn Rs. 100 in your wallet.</p>
              <div class="input-group">
                <input type="text" class="form-control" id="referralCodeInput" value="<%= user.referralCode || 'N/A' %>" readonly>
                <button class="btn btn-outline-secondary" type="button" id="copyReferralBtn">
                  <i class="fas fa-copy me-1"></i>Copy
                </button>
              </div>
              <div class="form-text mt-2">
                <i class="fas fa-info-circle me-1"></i>
                Share this code with friends to earn rewards.
              </div>
            </div>
          </div>
        <% } else { %>
          <p>Please <a href="/auth/login">log in</a> to view your profile.</p>
        <% } %>
      </div>
    </div>
  </div>
</main>

<%- include('../partials/footer') %>

<script>
  window.PAGE_MESSAGE = <% if (locals.message) { %> { text: '<%-message.text %>', type: '<%-message.type || "info" %>' } <% } else { %> null <% } %>;
</script>

<script src="/js/pages/profile-page.js"></script>
