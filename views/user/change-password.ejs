<%- include('../partials/head', { title: 'Change Password' }) %>
  <%- include('../partials/header') %>

    <main class="container-fluid py-5">
      <div class="row g-4">
        <div class="col-12 col-md-3 col-lg-3">
          <div class="position-sticky" style="top: 5rem;">
            <%- include('../partials/profile-sidebar', { page: 'password' }) %>
          </div>
        </div>
        <div class="col-12 col-md-9 col-lg-9">
          <div class="ps-md-3 mt-4">
            <h1 class="mb-3">Change Password</h1>
            <hr class="mb-4">

            <% if (locals.user) { %>
              <div class="card">
                <div class="card-body">
                  <p class="text-muted mb-4">We'll send an OTP to your email to verify the password change.</p>

                  <form action="/user/change-password" method="POST">
                    
                    <div class="mb-3">
                      <label for="currentPassword" class="form-label">Current Password <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword"
                          placeholder="Enter current password">
                        <button type="button" class="btn btn-outline-secondary js-toggle-password">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-primary" id="verifyCurrentPwdBtn">Verify</button>
                      </div>
                      <div id="verifyMessage" class="form-text mt-1"></div>
                      <% if (locals.errors && locals.errors.currentPassword) { %>
                        <small class="text-danger d-block mt-1">
                          <%= locals.errors.currentPassword.msg %>
                        </small>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label for="newPassword" class="form-label">New Password <span
                          class="text-danger">*</span></label>
                      <div class="password-field">
                        <input type="password"
                          class="form-control <%= locals.errors && locals.errors.newPassword ? 'is-invalid' : '' %>"
                          id="newPassword" name="newPassword" autocomplete="new-password"
                          placeholder="Min 6 chars, 1 uppercase, 1 number">
                        <button type="button" class="password-toggle-btn js-toggle-password">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <small class="form-text text-muted">Minimum 6 characters, at least 1 uppercase letter and 1
                        number</small>
                      <% if (locals.errors && locals.errors.newPassword) { %>
                        <small class="text-danger d-block mt-1">
                          <%= locals.errors.newPassword.msg %>
                        </small>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label for="confirmPassword" class="form-label">Confirm Password <span
                          class="text-danger">*</span></label>
                      <div class="password-field">
                        <input type="password"
                          class="form-control <%= locals.errors && locals.errors.confirmPassword ? 'is-invalid' : '' %>"
                          id="confirmPassword" name="confirmPassword" autocomplete="new-password"
                          placeholder="Re-enter password">
                        <button type="button" class="password-toggle-btn js-toggle-password">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <% if (locals.errors && locals.errors.confirmPassword) { %>
                        <small class="text-danger d-block mt-1">
                          <%= locals.errors.confirmPassword.msg %>
                        </small>
                        <% } %>
                    </div>

                    <div class="mt-4">
                      <button type="submit" class="btn btn-primary">
                        Proceed to OTP Verification
                      </button>
                      <a href="/user/profile" class="btn btn-secondary">Cancel</a>
                    </div>
                  </form>
                </div>
              </div>
              <% } else { %>
                <p>Please <a href="/auth/login">log in</a> to change your password.</p>
                <% } %>
          </div>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const verifyBtn = document.getElementById('verifyCurrentPwdBtn');
        const verifyMsg = document.getElementById('verifyMessage');
        const currentPwdInput = document.getElementById('currentPassword');

        verifyBtn.addEventListener('click', async () => {
          const currentPassword = currentPwdInput.value;
          if (!currentPassword) {
            verifyMsg.textContent = 'Please enter your current password.';
            verifyMsg.className = 'form-text mt-1 text-danger';
            return;
          }

          verifyBtn.disabled = true;
          verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

          try {
            const response = await fetch('/user/change-password/verify', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ currentPassword })
            });
            const data = await response.json();

            if (data.success) {
              verifyMsg.textContent = data.message;
              verifyMsg.className = 'form-text mt-1 text-success';
              currentPwdInput.classList.add('is-valid');
              currentPwdInput.classList.remove('is-invalid');
            } else {
              verifyMsg.textContent = data.message;
              verifyMsg.className = 'form-text mt-1 text-danger';
              currentPwdInput.classList.add('is-invalid');
              currentPwdInput.classList.remove('is-valid');
            }
          } catch (error) {
            console.error('Error:', error);
            verifyMsg.textContent = 'An error occurred. Please try again.';
            verifyMsg.className = 'form-text mt-1 text-danger';
          } finally {
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify';
          }
        });
      });
    </script>

    <%- include('../partials/footer') %>