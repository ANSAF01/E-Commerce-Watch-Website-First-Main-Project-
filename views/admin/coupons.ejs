<%- include('./partials/header', { title: 'Coupons' }) %>

  <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Coupons</h1>
  </div>

  <% if (locals.success && locals.success.length> 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fas fa-check-circle me-2"></i>
      <%= success[0] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <% } %>
      <% if (locals.error && locals.error.length> 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle me-2"></i>
          <%= error[0] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <% } %>

          <div class="row g-4">
            <!-- FLAT Coupon Form -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header bg-success text-white">
                  <h5 class="mb-0"><i class="fas fa-tag me-2"></i>Flat Discount</h5>
                </div>
                <div class="card-body">
                  <form method="POST" action="/admin/coupons/add" id="flatForm">
                    <input type="hidden" name="type" value="FLAT">

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Code</label>
                      <input type="text"
                        class="form-control <%= errors.code && old.type === 'FLAT' ? 'is-invalid' : '' %>" name="code"
                        placeholder="e.g., FLAT100" value="<%= old.type === 'FLAT' ? (old.code || '') : '' %>">
                      <% if (errors.code && old.type==='FLAT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.code.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Discount Amount (₹)</label>
                      <input type="number"
                        class="form-control <%= errors.discountValue && old.type === 'FLAT' ? 'is-invalid' : '' %>"
                        name="discountValue" placeholder="e.g., 100"
                        value="<%= old.type === 'FLAT' ? (old.discountValue || '') : '' %>" step="0.01" min="0">
                      <% if (errors.discountValue && old.type==='FLAT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.discountValue.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Minimum Purchase (₹)</label>
                      <input type="number"
                        class="form-control <%= errors.minPurchase && old.type === 'FLAT' ? 'is-invalid' : '' %>"
                        name="minPurchase" placeholder="e.g., 500"
                        value="<%= old.type === 'FLAT' ? (old.minPurchase || '') : '' %>" step="0.01" min="0">
                      <% if (errors.minPurchase && old.type==='FLAT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.minPurchase.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Expiry Date (Optional)</label>
                      <input type="date"
                        class="form-control <%= errors.expiresAt && old.type === 'FLAT' ? 'is-invalid' : '' %>"
                        name="expiresAt" value="<%= old.type === 'FLAT' ? (old.expiresAt || '') : '' %>">
                      <% if (errors.expiresAt && old.type==='FLAT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.expiresAt.msg %>
                        </div>
                        <% } %>
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                      <i class="fas fa-plus me-2"></i>Add Flat Coupon
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <!-- PERCENT Coupon Form -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header bg-info text-white">
                  <h5 class="mb-0"><i class="fas fa-percent me-2"></i>Percentage Discount</h5>
                </div>
                <div class="card-body">
                  <form method="POST" action="/admin/coupons/add" id="percentForm">
                    <input type="hidden" name="type" value="PERCENT">

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Code</label>
                      <input type="text"
                        class="form-control <%= errors.code && old.type === 'PERCENT' ? 'is-invalid' : '' %>"
                        name="code" placeholder="e.g., SAVE20"
                        value="<%= old.type === 'PERCENT' ? (old.code || '') : '' %>">
                      <% if (errors.code && old.type==='PERCENT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.code.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Discount Percentage (%)</label>
                      <input type="number"
                        class="form-control <%= errors.discountValue && old.type === 'PERCENT' ? 'is-invalid' : '' %>"
                        name="discountValue" placeholder="e.g., 20"
                        value="<%= old.type === 'PERCENT' ? (old.discountValue || '') : '' %>" step="0.01" min="0"
                        max="100">
                      <% if (errors.discountValue && old.type==='PERCENT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.discountValue.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Maximum Discount (₹)</label>
                      <input type="number"
                        class="form-control <%= errors.maxDiscount && old.type === 'PERCENT' ? 'is-invalid' : '' %>"
                        name="maxDiscount" placeholder="e.g., 500"
                        value="<%= old.type === 'PERCENT' ? (old.maxDiscount || '') : '' %>" step="0.01" min="0">
                      <% if (errors.maxDiscount && old.type==='PERCENT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.maxDiscount.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Minimum Purchase (₹)</label>
                      <input type="number"
                        class="form-control <%= errors.minPurchase && old.type === 'PERCENT' ? 'is-invalid' : '' %>"
                        name="minPurchase" placeholder="e.g., 1000"
                        value="<%= old.type === 'PERCENT' ? (old.minPurchase || '') : '' %>" step="0.01" min="0">
                      <% if (errors.minPurchase && old.type==='PERCENT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.minPurchase.msg %>
                        </div>
                        <% } %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Expiry Date (Optional)</label>
                      <input type="date"
                        class="form-control <%= errors.expiresAt && old.type === 'PERCENT' ? 'is-invalid' : '' %>"
                        name="expiresAt" value="<%= old.type === 'PERCENT' ? (old.expiresAt || '') : '' %>">
                      <% if (errors.expiresAt && old.type==='PERCENT' ) { %>
                        <div class="invalid-feedback d-block">
                          <%= errors.expiresAt.msg %>
                        </div>
                        <% } %>
                    </div>

                    <button type="submit" class="btn btn-info w-100 text-white">
                      <i class="fas fa-plus me-2"></i>Add Percentage Coupon
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Coupons List -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light">
                  <h5 class="mb-0">All Coupons (<%= coupons.length %>)</h5>
                </div>
                <div class="card-body p-0">
                  <% if (coupons.length===0) { %>
                    <div class="p-4 text-center text-muted">
                      <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                      <p>No coupons created yet</p>
                    </div>
                    <% } else { %>
                      <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                          <thead class="table-light">
                            <tr>
                              <th>Code</th>
                              <th>Type</th>
                              <th>Discount</th>
                              <th>Min Purchase</th>
                              <th>Max Discount</th>
                              <th>Status</th>
                              <th class="text-end">Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% coupons.forEach(coupon=> { %>
                              <tr>
                                <td><strong>
                                    <%= coupon.code %>
                                  </strong></td>
                                <td>
                                  <% if (coupon.type==='PERCENT' ) { %>
                                    <span class="badge bg-info">%</span>
                                    <% } else { %>
                                      <span class="badge bg-success">₹</span>
                                      <% } %>
                                </td>
                                <td>
                                  <%= coupon.discountValue %>
                                    <%= coupon.type==='PERCENT' ? '%' : '₹' %>
                                </td>
                                <td>
                                  <%= coupon.minPurchase> 0 ? '₹' + coupon.minPurchase : '—' %>
                                </td>
                                <td>
                                  <%= coupon.maxDiscount> 0 ? '₹' + coupon.maxDiscount : '—' %>
                                </td>
                                <td>
                                  <% if (coupon.isActive) { %>
                                    <span class="badge bg-success">Active</span>
                                    <% } else { %>
                                      <span class="badge bg-secondary">Inactive</span>
                                      <% } %>
                                </td>
                                <td class="text-end">
                                  <div class="d-flex align-items-center gap-2 justify-content-end">
                                    <a href="/admin/coupons/<%= coupon._id %>/edit"
                                      class="btn btn-sm btn-outline-primary me-2">
                                      <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                    <label class="toggle-switch">
                                      <input type="checkbox" class="toggle-coupon-switch" data-id="<%= coupon._id %>"
                                        <%=coupon.isActive ? 'checked' : '' %>>
                                      <span class="slider"></span>
                                    </label>
                                    <span class="status-text">
                                      <%= coupon.isActive ? 'Active' : 'Inactive' %>
                                    </span>
                                    <button class="btn btn-sm btn-outline-danger delete-coupon"
                                      data-id="<%= coupon._id %>">
                                      Delete
                                    </button>
                                  </div>
                                </td>
                              </tr>
                              <% }) %>
                          </tbody>
                        </table>
                      </div>
                      <% } %>
                </div>
              </div>
            </div>
          </div>
          </div>
          </div>

          <%- include('./partials/footer') %>