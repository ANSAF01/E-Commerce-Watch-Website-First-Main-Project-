<%- include('./partials/header', { title: 'Dashboard' }) %>

  <div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h2 fw-bold mb-1">Dashboard</h1>
        <p class="text-muted small">Welcome back! Here's your store overview.</p>
      </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <p class="text-muted small mb-1">Total Users</p>
                <h3 class="fw-bold mb-0">
                  <%= metrics.userCount || 0 %>
                </h3>
              </div>
              <div class="bg-primary bg-opacity-10 p-3 rounded">
                <i class="fas fa-users text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <p class="text-muted small mb-1">Total Products</p>
                <h3 class="fw-bold mb-0">
                  <%= metrics.productCount || 0 %>
                </h3>
              </div>
              <div class="bg-success bg-opacity-10 p-3 rounded">
                <i class="fas fa-box text-success"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <p class="text-muted small mb-1">Total Categories</p>
                <h3 class="fw-bold mb-0">
                  <%= metrics.categoryCount || 0 %>
                </h3>
              </div>
              <div class="bg-info bg-opacity-10 p-3 rounded">
                <i class="fas fa-list text-info"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <p class="text-muted small mb-1">Total Orders</p>
                <h3 class="fw-bold mb-0">
                  <%= metrics.orderCount || 0 %>
                </h3>
              </div>
              <div class="bg-warning bg-opacity-10 p-3 rounded">
                <i class="fas fa-shopping-bag text-warning"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales Chart -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0 fw-bold">Sales Overview</h5>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="daily">Daily</button>
                <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="weekly">Weekly</button>
                <button type="button" class="btn btn-outline-secondary filter-btn active"
                  data-filter="monthly">Monthly</button>
                <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="yearly">Yearly</button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <canvas id="salesChart" style="max-height: 300px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Products & Categories -->
    <div class="row g-3 mb-4">
      <!-- Top Products -->
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0 fw-bold">
              <i class="fas fa-fire text-danger me-2"></i>Top Selling Products
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (locals.topProducts && topProducts.length> 0) { %>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-3">Product</th>
                      <th class="text-end">Sold</th>
                      <th class="text-end pe-3">Revenue</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% topProducts.forEach((p, index)=> { %>
                      <tr>
                        <td class="ps-3">
                          <span class="badge bg-light text-dark me-2">
                            <%= index + 1 %>
                          </span>
                          <span class="text-truncate d-inline-block" style="max-width: 150px;" title="<%= p.name %>">
                            <%= p.name %>
                          </span>
                        </td>
                        <td class="text-end"><span class="badge bg-primary">
                            <%= p.totalQuantity %>
                          </span></td>
                        <td class="text-end pe-3 fw-semibold">₹<%= p.totalRevenue %>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>
              <% } else { %>
                <div class="text-center py-5 text-muted">
                  <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                  <p class="mb-0">No sales data available</p>
                </div>
                <% } %>
          </div>
        </div>
      </div>

      <!-- Top Categories -->
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0 fw-bold">
              <i class="fas fa-chart-pie text-success me-2"></i>Top Categories
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (locals.topCategories && topCategories.length> 0) { %>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-3">Category</th>
                      <th class="text-end">Sold</th>
                      <th class="text-end pe-3">Revenue</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% topCategories.forEach((c, index)=> { %>
                      <tr>
                        <td class="ps-3">
                          <span class="badge bg-light text-dark me-2">
                            <%= index + 1 %>
                          </span>
                          <span class="text-truncate d-inline-block" style="max-width: 150px;"
                            title="<%= c.categoryName %>">
                            <%= c.categoryName %>
                          </span>
                        </td>
                        <td class="text-end"><span class="badge bg-success">
                            <%= c.totalQuantity %>
                          </span></td>
                        <td class="text-end pe-3 fw-semibold">₹<%= c.totalRevenue %>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>
              <% } else { %>
                <div class="text-center py-5 text-muted">
                  <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                  <p class="mb-0">No sales data available</p>
                </div>
                <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0 fw-bold">
              <i class="fas fa-clock text-info me-2"></i>Recent Orders
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (locals.latestOrders && latestOrders.length> 0) { %>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-3">Order ID</th>
                      <th>Customer</th>
                      <th>Status</th>
                      <th class="text-end">Amount</th>
                      <th>Date</th>
                      <th class="text-end pe-3">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% latestOrders.forEach(o=> { %>
                      <tr>
                        <td class="ps-3">
                          <span class="fw-semibold text-primary">
                            <%= o.orderId %>
                          </span>
                        </td>
                        <td>
                          <span class="text-truncate d-inline-block" style="max-width: 150px;"
                            title="<%= o.userId ? o.userId.fullname : '—' %>">
                            <%= o.userId ? o.userId.fullname : '—' %>
                          </span>
                        </td>
                        <td>
                          <% let badgeClass='bg-info' ; %>
                            <% if (o.status==='DELIVERED' ) badgeClass='bg-success' ; %>
                              <% if (o.status==='CANCELLED' ) badgeClass='bg-danger' ; %>
                                <% if (o.status==='PENDING' ) badgeClass='bg-warning text-dark' ; %>
                                  <% if (o.status==='CONFIRMED' ) badgeClass='bg-primary' ; %>
                                    <% if (o.status==='SHIPPED' ) badgeClass='bg-info' ; %>
                                      <% if (o.status==='OUT_FOR_DELIVERY' ) badgeClass='bg-info' ; %>
                                        <span class="badge <%= badgeClass %>">
                                          <%= o.status %>
                                        </span>
                        </td>
                        <td class="text-end fw-semibold">₹<%= o.displayGrandTotal %>
                        </td>
                        <td><small class="text-muted">
                            <%= o.displayDate %>
                          </small></td>
                        <td class="text-end pe-3">
                          <a href="/admin/orders/<%= o._id %>" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>
              <% } else { %>
                <div class="text-center py-5 text-muted">
                  <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                  <p class="mb-0">No orders yet</p>
                </div>
                <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    window.INITIAL_CHART_DATA = <%- chartData %>;
  </script>
  <script src="/js/admin/dashboard-page.js"></script>

  <%- include('./partials/footer') %>